if (!window.dispositivosController) {
  const dispositivosController = {
    initialize: function () {
      var inicializado = false;
      const containerDispositivos = document.querySelector(".js-container-dispositivos");

      function renderDispositivos(dispositivos) {
        containerDispositivos.innerHTML = "";
        const listaDispositivos = document.createElement("ul");

        dispositivos.forEach(function (dispositivo) {
          const itemDispositivo = document.createElement("li");
          itemDispositivo.id = `dispositivo-${dispositivo.pino}`;

          const spanNome = document.createElement("span");
          spanNome.textContent = dispositivo.nome;
          itemDispositivo.appendChild(spanNome);

          const divLamp = document.createElement("div");
          divLamp.classList.add("lamp");
          if (dispositivo.nome === "Bomba Entrada" || dispositivo.nome === "Bomba Saida") {
            divLamp.style.position = "relative";
          } else {
            divLamp.style.position = "absolute";
          }

          const imgLamp = document.createElement("img");
          imgLamp.src = dispositivo.estado ? dispositivo.imageon : dispositivo.imageoff;
          imgLamp.width = dispositivo.largura;
          imgLamp.height = dispositivo.altura;
          imgLamp.className = "imgDispositivo";
          imgLamp.style.padding = dispositivo.preenchimento;
          divLamp.appendChild(imgLamp);

          if (dispositivo.mostrabotao === 1) {
            const imgBotao = document.createElement("img");
            imgBotao.src = dispositivo.estado ? "img/Botao_Desliga.png" : "img/Botao_Liga.png";
            imgBotao.width = 30;
            imgBotao.height = 30;
            imgBotao.className = "btnDispositivo";
            imgBotao.style.position = "absolute"; // Adicionado
            imgBotao.style.bottom = "4px"; // Ajuste conforme necessário
            imgBotao.style.left = "32%"; // Centralizado
            imgBotao.style.transform = "translateX(-50%)"; // Centralizado

            imgBotao.addEventListener("click", function () {
              enviarComando(dispositivo.pino);
            });
            divLamp.appendChild(imgBotao);
          }
          itemDispositivo.appendChild(divLamp);

          if (dispositivo.nome === "Bomba Entrada" || dispositivo.nome === "Bomba Saida") {
            const imgNivel = document.createElement("img");
            if (dispositivo.nome === "Bomba Entrada") {
              imgNivel.src = dispositivo.estado ? "img/CaixaEnchendo.gif" : "img/SemImagemNivel.gif";
            } else if (dispositivo.nome === "Bomba Saida") {
              imgNivel.src = dispositivo.estado ? "img/CaixaEsvaziando.gif" : "img/SemImagemNivel.gif";
            }
            imgNivel.width = 130;
            imgNivel.height = 130;
            imgNivel.className = "imgNivelDispositivo";
            imgNivel.style.padding = "0px 10px";
            itemDispositivo.appendChild(imgNivel);
          }
          listaDispositivos.appendChild(itemDispositivo);
        });
        containerDispositivos.appendChild(listaDispositivos);
      }

      function atualizarDispositivosHTML(dispositivos) {
        dispositivos.forEach(dispositivo => {
          const itemDispositivo = document.querySelector(`#dispositivo-${dispositivo.pino}`);
          if (!itemDispositivo) return;

          const imgDispositivo = itemDispositivo.querySelector(".imgDispositivo");
          imgDispositivo.src = dispositivo.estado ? dispositivo.imageon : dispositivo.imageoff;
          if (dispositivo.mostrabotao === 1) {
            const btnDispositivo = itemDispositivo.querySelector(".btnDispositivo");
            btnDispositivo.src = dispositivo.estado ? "img/Botao_Desliga.png" : "img/Botao_Liga.png";
          }

          if (dispositivo.nome === "Bomba Entrada" || dispositivo.nome === "Bomba Saida") {
            const imgNivelDispositivo = itemDispositivo.querySelector(".imgNivelDispositivo");
            if (dispositivo.nome === "Bomba Entrada") {
              imgNivelDispositivo.src = dispositivo.estado ? "img/CaixaEnchendo.gif" : "img/SemImagemNivel.gif";
            } else if (dispositivo.nome === "Bomba Saida") {
              imgNivelDispositivo.src = dispositivo.estado ? "img/CaixaEsvaziando.gif" : "img/SemImagemNivel.gif";
            }
          }
        });
      }

      function atualizarDispositivos() {
        fetch("/api/dispositivos")
          .then((response) => response.json())
          .then((data) => {
            let dispositivos = data.dispositivos;
            if (inicializado) {
              atualizarDispositivosHTML(dispositivos);
            } else {
              renderDispositivos(dispositivos);
              inicializado = true;
            }
          })
          .catch((error) => console.error("Erro ao buscar dispositivos:", error));
      }

      function enviarComando(pino) {
        fetch('/api/comando', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            pino: pino,
          })
        })
          .then(response => response.json())
          .then(() => atualizarDispositivos())
          .catch(error => console.error('Erro ao enviar comando:', error));
      }

      function verificarValorSensor() {
        fetch("/api/sensores")
          .then((response) => response.json())
          .then((data) => {
            const sensores = data.sensor;
            sensores.forEach(sensor => {
              if (sensor.id === "sensorNivel") {
                const valorSensor = parseFloat(sensor.valor);
                const bombaEntrada = document.querySelector("#dispositivo-4 .imgDispositivo").src.includes("On");
                const bombaSaida = document.querySelector("#dispositivo-5 .imgDispositivo").src.includes("On");
                const alarme = document.querySelector("#dispositivo-14 .imgDispositivo").src.includes("On");
                console.log(bombaEntrada, bombaSaida, alarme, valorSensor);
                if (!bombaEntrada && !bombaSaida && !alarme) {
                  if (valorSensor >= 12 && valorSensor <= 14) {

                    enviarComando(4); // Liga Bomba Entrada (pino 4)
                  } else if (valorSensor <= 4 && valorSensor >= 3) {

                    enviarComando(5); // Liga Bomba Saída (pino 5)
                  }
                } else if (bombaEntrada && valorSensor <= 5)  {
                  enviarComando(4); // Desliga Bomba Entrada (pino 4)
                } else if (bombaSaida && valorSensor >= 12) {
                  enviarComando(5); // Desliga Bomba Saída (pino 5)
                }
                if (!alarme) {
                  if ((valorSensor >= 14) || (valorSensor <= 3)) {
                    enviarComando(14); // Liga Alarme (pino 14)
                    if (bombaEntrada) {
                      enviarComando(4); // Desliga Bomba Entrada (pino 4)
                    } else if (bombaSaida) {
                      enviarComando(5); // Desliga Bomba Saída (pino 5)
                    }
                  }
                } else if (alarme && (valorSensor <= 12 && valorSensor >= 3)) {
                  enviarComando(14); // Desliga Alarme (pino 14)
                }
              }
            });
          })
          .catch((error) => console.error("Erro ao buscar sensores:", error));
      }

      setInterval(() => {
        atualizarDispositivos();
        verificarValorSensor();
      }, 1500);
      atualizarDispositivos();
      verificarValorSensor();
    }
  };

  // Certifique-se de que o controlador está acessível globalmente
  window.dispositivosController = dispositivosController;
}
